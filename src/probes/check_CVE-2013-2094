#!/bin/bash

# nagios check for CVE-2013-2094
# version 0.5

NAGIOS_OK=0
NAGIOS_WARNING=1
NAGIOS_ERROR=2
NAGIOS_UNKNOWN=3

OK_KERNEL="2.6.32-358.6.2.el6"
MITIGATION="cve_2013_2094-0.2-1.el6"
RUNNING_KERNEL=$(uname -r)

verlte() {
    [ "$1" = "$(echo -e "$1\n$2" | sort -V | head -n1)" ]
}

# check for affected distribution
if [[ $RUNNING_KERNEL =~ ".el5" ]]
then
  MSG="OS (RHEL 5 or derived) is not affected"
else
  # check for running kernel >= 2.6.32-358.6.2.el6
  if verlte $OK_KERNEL.$(uname -m) $RUNNING_KERNEL
  then
    MSG="kernel $RUNNING_KERNEL is installed"
  else
    # check for installed mitigation
    if rpm --quiet --query $MITIGATION
    then
      MSG="mitigation $MITIGATION is installed"
    fi
  fi
fi

if [ -z "$MSG" ]
then
  echo "CRITICAL: vulnerable kernel $RUNNING_KERNEL found without mitigation installed"
  exit $NAGIOS_ERROR
else
  echo "OK: $MSG"
  exit $NAGIOS_OK
fi

